#!/bin/sh

clear
mkdir -p /proc /sys /dev /tmp /etc

mount -t proc none /proc || exit 1
mount -t sysfs none /sys || exit 1
mount -t devtmpfs none /dev || exit 1
mount -t tmpfs none /tmp || exit 1

[ -e /dev/null ] || mknod -m 666 /dev/null c 1 3
[ -e /dev/console ] || mknod -m 600 /dev/console c 5 1
[ -e /dev/tty ] || mknod -m 666 /dev/tty c 5 0

echo "pingvin320kg" > /proc/sys/kernel/hostname
ip link set lo up
echo "nameserver 8.8.8.8" > /etc/resolv.conf
echo "nameserver 1.1.1.1" >> /etc/resolv.conf

if [ ! -f /etc/udhcpc.script ]; then
    cat > /etc/udhcpc.script << 'EOF'
#!/bin/sh
case "$1" in
    deconfig)
        ip addr flush dev "$interface"
        ;;
    renew|bound)
        ip addr add "$ip/$subnet" dev "$interface"
        [ -n "$router" ] && ip route add default via "$router"
        [ -n "$dns" ] && echo "nameserver $dns" > /etc/resolv.conf
        ;;
esac
EOF
    chmod +x /etc/udhcpc.script
fi

for iface in /sys/class/net/*; do
    iface_name=$(basename "$iface")
    if [ -z "$iface_name" ]; then
        continue
    fi
    if [ "$iface_name" != "lo" ] && [ "$iface_name" != "sit0" ]; then
        if ip link set "$iface_name" up; then
            if udhcpc -i "$iface_name" -s /etc/udhcpc.script -n -q; then
                IP=$(ip addr show "$iface_name" | grep 'inet ' | awk '{print $2}')
            fi
        fi
        sleep 1
    fi
done

export PATH=/bin:/sbin:/usr/bin:/usr/sbin
export HOME=/root
export LD_LIBRARY_PATH=/usr/lib:/lib64

while true; do
    setsid sh -c 'exec sh </dev/console >/dev/console 2>&1'
    sleep 2
done
